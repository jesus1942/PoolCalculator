generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String?  // Nullable para usuarios de OAuth
  name      String
  role      Role     @default(USER)
  currentOrgId String?
  currentOrg   Organization? @relation("OrgCurrent", fields: [currentOrgId], references: [id])

  // OAuth fields
  googleId  String?  @unique
  provider  AuthProvider? // google, email, etc

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  poolPresets         PoolPreset[]
  projects            Project[]
  businessRules      BusinessRule[]
  calculationSettings CalculationSettings?
  professionRoles     ProfessionRole[]
  passwordResetTokens PasswordResetToken[]
  crewsOwned          Crew[]
  crewMemberships     CrewMember[]
  agendaEvents        AgendaEvent[]
  agendaAssignments   AgendaAssignment[]
  agendaReminders     AgendaReminder[]
  systemLogs          SystemLog[]
  agendaMessages      AgendaMessage[]
  organizationMemberships OrganizationMember[]
  organizationsOwned       Organization[] @relation("OrgOwner")
}

enum AuthProvider {
  EMAIL
  GOOGLE
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
}

enum Role {
  SUPERADMIN  // Acceso total, gestiona otros admins
  ADMIN       // Gestiona su organización/cuenta
  INSTALLER   // Instalador (solo reporta avances)
  USER        // Usuario estándar
  VIEWER      // Solo lectura (para SaaS)
}

model Organization {
  id          String   @id @default(uuid())
  name        String
  slug        String?  @unique
  ownerId     String?
  owner       User?    @relation("OrgOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  currentUsers User[]  @relation("OrgCurrent")
  members     OrganizationMember[]
  projects    Project[]
  agendaEvents AgendaEvent[]
  crews       Crew[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model OrganizationMember {
  id             String           @id @default(uuid())
  organizationId String
  userId         String
  role           OrganizationRole @default(MEMBER)

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([organizationId, userId])
  @@index([userId])
}

enum OrganizationRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

model Crew {
  id          String   @id @default(uuid())
  name        String
  description String?

  ownerId     String
  owner       User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  members     CrewMember[]
  events      AgendaEvent[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([ownerId, name])
}

model CrewMember {
  id        String   @id @default(uuid())
  crewId    String
  userId    String
  role      CrewRole @default(MEMBER)

  crew      Crew     @relation(fields: [crewId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([crewId, userId])
}

enum CrewRole {
  LEAD
  MEMBER
}

model AgendaEvent {
  id               String              @id @default(uuid())
  title            String
  type             AgendaEventType
  status           AgendaEventStatus   @default(PLANNED)
  priority         AgendaEventPriority @default(NORMAL)
  typeColor        String              @default("#0ea5e9")
  statusColor      String              @default("#22c55e")
  startAt          DateTime
  endAt            DateTime
  allDay           Boolean             @default(false)
  location         String?
  notesInternal    String?
  notesInstaller   String?
  assigneesCanEdit Boolean             @default(true)
  lockedByAdmin    Boolean             @default(false)

  ownerId          String
  owner            User                @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  organizationId  String?
  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  projectId        String?
  project          Project?            @relation(fields: [projectId], references: [id], onDelete: SetNull)

  crewId           String?
  crew             Crew?               @relation(fields: [crewId], references: [id], onDelete: SetNull)

  assignees        AgendaAssignment[]
  checklist        AgendaChecklistItem[]
  reminders        AgendaReminder[]
  messages         AgendaMessage[]

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([ownerId, startAt])
  @@index([projectId])
  @@index([crewId])
}

model AgendaChecklistItem {
  id        String   @id @default(uuid())
  eventId   String
  label     String
  done      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  event     AgendaEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
}

model AgendaAssignment {
  id        String            @id @default(uuid())
  eventId   String
  userId    String
  role      AgendaAssigneeRole @default(INSTALLER)

  event     AgendaEvent       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([eventId, userId])
  @@index([userId])
}

enum AgendaEventType {
  VISIT
  INSTALLATION
  MAINTENANCE
  INSPECTION
  DELIVERY
  OTHER
}

enum AgendaEventStatus {
  PLANNED
  CONFIRMED
  IN_PROGRESS
  DONE
  CANCELED
}

enum AgendaEventPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum AgendaAssigneeRole {
  INSTALLER
  MANAGER
  VIEWER
}

model AgendaReminder {
  id           String               @id @default(uuid())
  eventId      String
  userId       String
  remindAt     DateTime
  status       AgendaReminderStatus @default(PENDING)
  snoozedUntil DateTime?
  emailSentAt  DateTime?

  event        AgendaEvent          @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([eventId, userId])
  @@index([userId, remindAt])
  @@index([eventId])
  @@index([emailSentAt, remindAt])
}

enum AgendaReminderStatus {
  PENDING
  SNOOZED
  DISMISSED
}

enum SystemLogLevel {
  INFO
  WARN
  ERROR
}

enum SystemLogCategory {
  AGENDA_NOTIFY
  AGENDA_REMINDER
  SYSTEM
}

model SystemLog {
  id        String           @id @default(uuid())
  level     SystemLogLevel
  category  SystemLogCategory
  message   String
  meta      Json?
  userId    String?
  eventId   String?
  createdAt DateTime         @default(now())

  user      User?            @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([level, createdAt])
  @@index([category, createdAt])
}

model AgendaMessage {
  id         String                @id @default(uuid())
  eventId    String
  userId     String
  body       String
  images     Json                  @default("[]")
  visibility AgendaMessageVisibility @default(ALL)

  event      AgendaEvent           @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user       User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([eventId])
  @@index([userId])
}

enum AgendaMessageVisibility {
  ALL
  ADMIN_ONLY
}

model ProfessionRole {
  id          String  @id @default(uuid())
  name        String
  description String?
  hourlyRate  Float?
  dailyRate   Float?
  billingType ProfessionBillingType @default(HOUR)
  ratePerUnit Float?
  bocaRates   Json?
  
  userId      String
  user        User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([userId, name])
}

enum ProfessionBillingType {
  HOUR
  DAY
  M2
  ML
  BOCA
}

model PlumbingItem {
  id           String       @id @default(uuid())
  name         String
  category     PlumbingCategory
  type         PlumbingType
  diameter     String?
  length       Float?
  unit         String
  pricePerUnit Float
  brand        String?
  description  String?
  imageUrl    String?              // URL de la imagen principal
  additionalImages String[] @default([])  // URLs de imágenes adicionales
  catalogPage String?              // Página del catálogo de donde viene

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

enum PlumbingCategory {
  PIPE
  FITTING
  VALVE
  ACCESSORY
}

enum PlumbingType {
  PVC
  FUSION_FUSION
  FUSION_ROSCA
  POLIPROPILENO
  COBRE
  OTHER
}

model CalculationSettings {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Vereda
  adhesiveKgPerM2 Float @default(5.0)
  sidewalkBaseThicknessCm  Float @default(10.0)
  cementKgPerM3            Float @default(200.0)
  sandM3PerM3              Float @default(0.6)
  gravelM3PerM3            Float @default(0.8)
  groutJointWidthMm        Float @default(3.0)
  whiteCementKgPerLinealM  Float @default(0.15)
  marmolinaKgPerLinealM    Float @default(0.10)
  wireMeshOverlapCm        Float @default(10.0)
  wireMeshM2PerM2          Float @default(1.15)
  waterproofingKgPerM2     Float @default(0.0)
  waterproofingCoats       Int   @default(2)

  // Proporción de pastina (junta entre losetas)
  // Por defecto: 1 parte cemento blanco : 4 partes marmolina
  groutWhiteCementParts    Float @default(1.0)
  groutMarmolinaParts      Float @default(4.0)

  // Cama interna de la piscina
  bedThicknessCm           Float @default(10.0)
  bedCementBagsPerM3       Float @default(4.0)   // 4 bolsas por m³ de arena (1 bolsa : 0.25 m³)
  bedCementBagWeight       Float @default(50.0)
  bedSandM3PerCementBag    Float @default(0.25)  // 0.25 m³ de arena por bolsa de cemento
  drainTrenchWidthCm       Float @default(15.0)
  drainTrenchDepthCm       Float @default(15.0)
  geomembraneM2PerM2       Float @default(1.0)
  electroweldedMeshM2PerM2 Float @default(1.15)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PoolPreset {
  id          String   @id @default(uuid())
  name        String
  description String?
  imageUrl    String?
  additionalImages String[] @default([])
  backDescription  String?
  vendor      String?

  length      Float
  width       Float
  depth       Float
  depthEnd    Float?
  
  shape       PoolShape
  constructionType ConstructionType @default(FIBERGLASS)
  
  lateralCushionSpace Float @default(0.15)
  floorCushionDepth   Float @default(0.10)
  
  hasWetDeck        Boolean @default(false)
  hasStairsOnly     Boolean @default(false)
  
  returnsCount      Int     @default(2)
  hasHotWaterReturn Boolean @default(false)
  hasHydroJets      Boolean @default(false)
  hydroJetsCount    Int     @default(0)
  
  hasBottomDrain    Boolean @default(true)
  hasVacuumIntake   Boolean @default(true)
  vacuumIntakeCount Int     @default(1)
  
  hasSkimmer        Boolean @default(true)
  skimmerCount      Int     @default(1)
  
  hasLighting       Boolean @default(false)
  lightingCount     Int     @default(0)
  lightingType      String?
  
  tileConfig        Json?
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects Project[]
}

enum PoolShape {
  RECTANGULAR
  CIRCULAR
  OVAL
  JACUZZI
}

enum ConstructionType {
  FIBERGLASS
  CONCRETE
  BLOCKS
  PANELS
}

model TilePreset {
  id          String   @id @default(uuid())
  name        String
  type        TileType
  width       Float
  length      Float
  pricePerUnit Float
  brand       String?
  description String?
  imageUrl    String?              // URL de la imagen principal
  additionalImages String[] @default([])  // URLs de imágenes adicionales
  catalogPage String?              // Página del catálogo de donde viene

  hasCorner          Boolean @default(false)
  cornerPricePerUnit Float?
  cornersPerTile     Int?
  isForFirstRing     Boolean @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum TileType {
  COMMON
  LOMO_BALLENA
  L_FINISH
  PERIMETER
  ROMANA
  VENECIANA
  TROPICAL
  CLASICA
  MODERNA
  OTHER
}

model AccessoryPreset {
  id          String         @id @default(uuid())
  name        String
  type        AccessoryType
  unit        String
  pricePerUnit Float
  description String?
  imageUrl    String?              // URL de la imagen principal
  additionalImages String[] @default([])  // URLs de imágenes adicionales
  catalogPage String?              // Página del catálogo de donde viene

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  projectAdditionals ProjectAdditional[]
}

enum AccessoryType {
  CORNER
  TRIM
  GRILL
  BASEBOARD
  SKIMMER_ITEM
  RETURN_ITEM
  DRAIN_ITEM
  OTHER
}

model EquipmentPreset {
  id          String         @id @default(uuid())
  name        String         @unique
  type        EquipmentType
  category    EquipmentCategory @default(OPTIONAL)
  brand       String?
  model       String?
  power       Float?         // HP para bombas, kW para calefactores
  capacity    Float?         // Capacidad general
  voltage     Int?           // Voltaje (220V, 380V, 12V)
  pricePerUnit Float
  description String?
  imageUrl    String?              // URL de la imagen principal
  additionalImages String[] @default([])  // URLs de imágenes adicionales
  catalogPage String?              // Página del catálogo de donde viene
  datasheet   String?              // URL de la ficha técnica PDF

  // Campos para lógica de selección automática
  minPoolVolume Float?       // Volumen mínimo de piscina en litros
  maxPoolVolume Float?       // Volumen máximo de piscina en litros
  flowRate      Float?       // Caudal en m³/h para bombas
  maxHead       Float?       // Altura máxima en metros para bombas
  filterArea    Float?       // Área de filtración en m² para filtros
  filterDiameter Float?      // Diámetro del filtro en mm
  thermalPower  Float?       // Potencia térmica en Kcal/h para calefactores
  sandRequired  Float?       // Kg de arena necesarios para filtros
  consumption   Float?       // Consumo eléctrico en Watts
  connectionSize String?     // Tamaño de conexión (ej: "1 1/2\"", "2\"")

  // Relaciones recomendadas
  recommendedPumpModel String?   // Modelo de bomba recomendado para filtros
  recommendedFilterModel String? // Modelo de filtro recomendado para bombas

  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  projectAdditionals ProjectAdditional[]
}

enum EquipmentType {
  PUMP              // Bombas de filtrado
  FILTER            // Filtros de arena
  HEATER            // Calefactores a gas
  HEAT_PUMP         // Bombas de calor
  CHLORINATOR       // Cloradores
  LIGHTING          // Iluminación
  TRANSFORMER       // Transformadores
  SKIMMER           // Skimmers
  RETURN            // Retornos
  HYDRO_JET         // Hidrojets
  VACUUM_INTAKE     // Tomas de barrefondo
  OTHER             // Otros
}

enum EquipmentCategory {
  REQUIRED          // Equipos obligatorios (bomba + filtro)
  HEATING           // Climatización opcional
  ACCESSORIES       // Accesorios opcionales
  OPTIONAL          // Otros opcionales
}

model ConstructionMaterialPreset {
  id          String         @id @default(uuid())
  name        String
  type        MaterialType
  unit        String
  bagWeight   Float?         // Peso de la bolsa en kg (25, 30, 50, etc) - null si no es bolsa
  mixRatio    Json?
  pricePerUnit Float
  brand       String?
  description String?
  imageUrl    String?              // URL de la imagen principal
  additionalImages String[] @default([])  // URLs de imágenes adicionales
  catalogPage String?              // Página del catálogo de donde viene

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  projectAdditionals ProjectAdditional[]
}

enum MaterialType {
  CEMENT
  WHITE_CEMENT
  SAND
  STONE
  GRAVEL
  MARMOLINA
  WIRE_MESH
  WIRE
  NAILS
  WATERPROOFING
  GEOTEXTILE
  OTHER
}

model Project {
  id              String   @id @default(uuid())
  name            String
  clientName      String
  clientEmail     String?
  clientPhone     String?
  location        String?

  poolPresetId    String
  poolPreset      PoolPreset @relation(fields: [poolPresetId], references: [id])

  excavationLength Float
  excavationWidth  Float
  excavationDepth  Float

  perimeter       Float
  waterMirrorArea Float
  volume          Float

  tileCalculation Json
  totalTileArea   Float
  sidewalkArea    Float

  plumbingConfig  Json     @default("{}")
  electricalConfig Json    @default("{}")

  materials       Json
  tasks           Json
  exportSettings  Json     @default("{}")

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  laborCost       Float    @default(0)
  materialCost    Float    @default(0)
  totalCost       Float    @default(0)

  status          ProjectStatus @default(DRAFT)

  userId          String
  user            User     @relation(fields: [userId], references: [id])

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  projectAdditionals ProjectAdditional[]
  projectUpdates     ProjectUpdate[]
  projectShare       ProjectShare?
  agendaEvents       AgendaEvent[]
}

enum ProjectStatus {
  DRAFT
  BUDGETED
  APPROVED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model BusinessRule {
  id          String   @id @default(uuid())
  userId      String
  name        String
  category    String
  trigger     String
  conditions  Json
  actions     Json
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
  @@index([userId, category])
}

model ProjectAdditional {
  id           String   @id @default(uuid())
  projectId    String
  accessoryId  String?
  materialId   String?
  equipmentId  String?

  // Campos para items personalizados (cuando no se vincula con preset)
  customName        String?
  customCategory    String?
  customUnit        String?
  customPricePerUnit Float?
  customLaborCost   Float?

  baseQuantity Int
  newQuantity  Int

  dependencies Json

  // Relación con tareas generadas automáticamente
  generatedTaskId   String?  // ID de la tarea generada por este adicional
  relatedTaskCategory String? // Categoría de la tarea (excavation, hydraulic, etc)
  requiredRoleId    String?  // ID del rol/rubro requerido para esta tarea

  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  project   Project            @relation(fields: [projectId], references: [id])
  accessory AccessoryPreset?   @relation(fields: [accessoryId], references: [id])
  material  ConstructionMaterialPreset?    @relation(fields: [materialId], references: [id])
  equipment EquipmentPreset?   @relation(fields: [equipmentId], references: [id])

  @@index([projectId])
}

model ProjectUpdate {
  id          String   @id @default(uuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  title       String
  description String?
  category    UpdateCategory @default(PROGRESS)

  // Campos para imágenes (URLs o base64)
  images      Json     @default("[]")

  // Metadata adicional
  metadata    Json?

  // Control de visibilidad para compartir
  isPublic    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([projectId])
  @@index([createdAt])
}

enum UpdateCategory {
  PROGRESS
  MILESTONE
  ISSUE
  NOTE
  INSPECTION
  DELIVERY
  OTHER
}

model ProjectShare {
  id          String   @id @default(uuid())
  projectId   String   @unique
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  shareToken  String   @unique @default(uuid())
  isActive    Boolean  @default(true)

  // Autenticación para cliente
  clientUsername String  @unique
  clientPassword String  // Hash de la contraseña

  // Configuración de qué mostrar
  showCosts   Boolean  @default(false)
  showDetails Boolean  @default(true)

  expiresAt   DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([shareToken])
  @@index([clientUsername])
}

model ContactForm {
  id        String   @id @default(uuid())
  name      String
  email     String
  phone     String?
  subject   String
  message   String   @db.Text

  status    ContactStatus @default(PENDING)
  notes     String?  @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([status])
  @@index([createdAt])
}

model QuoteRequest {
  id              String   @id @default(uuid())
  name            String
  email           String
  phone           String
  location        String
  spaceLength     Float?
  spaceWidth      Float?
  selectedPoolId  String?
  additionalInfo  String?  @db.Text
  budget          String?
  timeframe       String?

  status          ContactStatus @default(PENDING)
  notes           String?  @db.Text

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([email])
  @@index([status])
  @@index([createdAt])
}

model CalculatorInquiry {
  id           String   @id @default(uuid())
  name         String
  email        String
  phone        String
  message      String?  @db.Text
  poolId       String?
  poolName     String?
  spaceLength  Float?
  spaceWidth   Float?

  status       ContactStatus @default(PENDING)
  notes        String?  @db.Text

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([email])
  @@index([status])
  @@index([createdAt])
}

enum ContactStatus {
  PENDING
  CONTACTED
  CONVERTED
  REJECTED
  ARCHIVED
}
